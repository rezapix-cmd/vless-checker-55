name: VLESS Reality Checker

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-configs:
    runs-on: ubuntu-latest
    # اضافه کردن دسترسی برای نوشتن در مخزن
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4 # استفاده از آخرین نسخه

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          mkdir -p configs
          touch all_configs.txt # جلوگیری از خطا در صورت خالی بودن فایل

      - name: Run checker
        run: |
          # پاک کردن فایل‌های قدیمی برای جلوگیری از تکرار
          > configs/alive.txt
          > configs/dead.txt
          
          while IFS= read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue # نادیده گرفتن خطوط خالی
            
            # نکته: این فقط در دسترس بودن سرور را چک می‌کند نه کارکرد VLESS را
            # برای تست واقعی باید از ابزار مخصوص استفاده شود
            if curl -Is --connect-timeout 5 "$line" > /dev/null 2>&1; then
              echo "$line" >> configs/alive.txt
            else
              echo "$line" >> configs/dead.txt
            fi
          done < all_configs.txt

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add configs/
          # فقط اگر تغییری وجود داشت کامیت کن
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update configs: $(date +'%Y-%m-%d')" && git push)
