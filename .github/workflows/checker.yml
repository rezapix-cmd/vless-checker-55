name: Auto VLESS Reality Prioritizer

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd
          mkdir -p configs

      - name: Fetch & Merge Configs
        run: |
          SOURCES=(
            "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/vless/reality"
            "https://raw.githubusercontent.com/barry-far/V2ray-Config/main/Sub1.txt"
            "https://raw.githubusercontent.com/10ium/free-sub-link/main/config-fetcher/vless"
            "https://raw.githubusercontent.com/Iranian-V2Ray/V2Ray-Configs/main/All_Configs_Sub.txt"
            "https://raw.githubusercontent.com/yebekhe/TVC/main/subscriptions/protocols/vless"
            "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt"
          )
          > all_configs.txt
          for url in "${SOURCES[@]}"; do
            curl -s --max-time 15 "$url" >> all_configs.txt || true
          done
          grep -E "vless://|vmess://|trojan://|ss://" all_configs.txt | sort -u > temp.txt && mv temp.txt all_configs.txt

      - name: Priority Quality Check
        run: |
          > configs/alive.txt
          COUNT=0
          MAX_CONFIGS=100
          
          grep -i "reality" all_configs.txt > reality_list.txt || touch reality_list.txt
          grep -iv "reality" all_configs.txt > others_list.txt || touch others_list.txt

          check_and_add() {
            TYPE=$2
            while IFS= read -r line; do
              [ $COUNT -ge $MAX_CONFIGS ] && break
              host=$(echo "$line" | sed -E 's/.*@([^:]+).*/\1/' | cut -d':' -f1 | cut -d'?' -f1 | cut -d'/' -f1)
              if timeout 2.5s nc -zw 2 "$host" 443 > /dev/null 2>&1; then
                # شماره‌گذاری و تمیز کردن نام کانفیگ برای نمایش بهتر در استریسند
                CLEAN_LINE=$(echo "$line" | sed -E "s/#.*/#${TYPE}-$(printf "%02d" $((COUNT+1)))/")
                echo "$CLEAN_LINE" >> configs/alive.txt
                COUNT=$((COUNT + 1))
              fi
            done < "$1"
          }

          check_and_add reality_list.txt "Reality"
          check_and_add others_list.txt "Config"

      - name: Generate Base64 Subscription
        run: |
          if [ -s configs/alive.txt ]; then
            base64 -w 0 configs/alive.txt > configs/sub.txt
          else
            echo "No configs found" | base64 > configs/sub.txt
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update: Found $COUNT configs" && git push)
